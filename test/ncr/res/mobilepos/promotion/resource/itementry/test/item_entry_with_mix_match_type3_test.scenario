Scenario: Test Item Entry with MixMatch Type 3
When the Web API Starts Up
Given a Promotion Service
Given a loaded dataset {items_for_mixmatch.xml}
Given a loaded dataset {mixmatch_promotions.xml}

Scenario: Item Entry (proportional distribution)
When a Begin Transaction at promotion with parameters RetailStoreID{0031} WorkStationId{1111} SequenceNo{1} TransactionJson{{"TransactionMode":"0","OperatorID": "0003","BeginDateTime":"2012-12-20T09:30:47.00"}}
When a Item Entry at promotion with parameters RetailStoreID{0031} WorkStationId{1111} SequenceNo{1} TransactionJson{{"Sale":{"ItemEntryID":"00001","ItemID":"1111111111131","ItemIDType":"EAN-13","Quantity":1}}}
Then the Result Code is 0
Then Sale data should be :
|ItemEntryID|ItemID       |ItemIDType|Quantity|Department|DescriptionEN|DescriptionJP|RegularSalesUnitPrice|Discount|DiscountAmount|ActualSalesUnitPrice|ExtendedAmount|Discountable|AgeRestrictedFlag|CouponFlag|
|00001      |1111111111131|EAN-13    |1       |0143      |Item A       |アイテムのA     |1980.0               |0.0     |0.0           |1980.0              |1980.0        |True        |1                |1         |
Then there should be no promotion data.
!-- 1
When a Item Entry at promotion with parameters RetailStoreID{0031} WorkStationId{1111} SequenceNo{1} TransactionJson{{"Sale":{"ItemEntryID":"00002","ItemID":"1111111111132","ItemIDType":"EAN-13","Quantity":1}}}
Then the Result Code is 0
Then Sale data should be :
|ItemEntryID|ItemID       |ItemIDType|Quantity|Department|DescriptionEN|DescriptionJP|RegularSalesUnitPrice|Discount|DiscountAmount|ActualSalesUnitPrice|ExtendedAmount|Discountable|AgeRestrictedFlag|CouponFlag|
|00002      |1111111111132|EAN-13    |1       |0143      |Item AA      |アイテムのAA    |1350.0               |0.0     |0.0           |1350.0              |1350.0        |True        |1                |0         |
Then there should be no promotion data.
!-- 2
When a Item Entry at promotion with parameters RetailStoreID{0031} WorkStationId{1111} SequenceNo{1} TransactionJson{{"Sale":{"ItemEntryID":"00003","ItemID":"1111111111133","ItemIDType":"EAN-13","Quantity":1}}}
Then the Result Code is 0
Then Sale data should be :
|ItemEntryID|ItemID       |ItemIDType|Quantity|Department|DescriptionEN|DescriptionJP|RegularSalesUnitPrice|Discount|DiscountAmount|ActualSalesUnitPrice|ExtendedAmount|Discountable|AgeRestrictedFlag|CouponFlag|
|00003      |1111111111133|EAN-13    |1       |0143      |Item G       |アイテムのG     |2000.0               |0.0     |0.0           |2000.0              |2000.0        |True        |0                |0         |
Then promotion should have the following data :
|RewardID|EarnedRewardID|PromotionCode|DiscountDescription|ItemEntryID|UnitDiscountAmount|
|1|9896|9896|Proportion Distribution 3|00003|1062|
|2|9896|9896|Proportion Distribution 3|00001|1051|
|3|9896|9896|Proportion Distribution 3|00002|717|
Then the JSON should have the following format :
{"Transaction":{"TransactionMode":0,"Sale":{"ItemID":"1111111111133","Department":"0143","Description":{"en":"Item G","jp":"アイテムのG"},"RegularSalesUnitPrice":2000.0,"Discount":0.0,"DiscountFlag":0,"DiscountAmount":0.0,"ActualSalesUnitPrice":2000.0,"Discountable":true,"TaxRate":0,"TaxType":0,"DiscountType":0,"NonSales":0,"SubInt10":0,"Line":"0143","Class":"000001","AgeRestrictedFlag":0,"CouponFlag":"0","EmpPrice1":2000.0,"PSType":"","OrgSalesPrice1":0.0,"ItemEntryID":"00003","ItemIDType":"EAN-13","Quantity":1,"ExtendedAmount":2000.0,"InputType":0},"EntryFlag":0},"Promotion":{"Discount":[{"RewardID":1,"EarnedRewardID":"9896","PromotionCode":"9896","DiscountDescription":"Proportion Distribution 3","ItemEntryID":"00003","UnitDiscountAmt":1062,"Quantity":1},{"RewardID":2,"EarnedRewardID":"9896","PromotionCode":"9896","DiscountDescription":"Proportion Distribution 3","ItemEntryID":"00001","UnitDiscountAmt":1051,"Quantity":1},{"RewardID":3,"EarnedRewardID":"9896","PromotionCode":"9896","DiscountDescription":"Proportion Distribution 3","ItemEntryID":"00002","UnitDiscountAmt":717,"Quantity":1}],"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0},"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0}
Then there should be no revoke
!-- 3
When a Item Entry at promotion with parameters RetailStoreID{0031} WorkStationId{1111} SequenceNo{1} TransactionJson{{"Sale":{"ItemEntryID":"00004","ItemID":"1111111111133","ItemIDType":"EAN-13","Quantity":1}}}
Then the Result Code is 0
Then Sale data should be :
|ItemEntryID|ItemID       |ItemIDType|Quantity|Department|DescriptionEN|DescriptionJP|RegularSalesUnitPrice|Discount|DiscountAmount|ActualSalesUnitPrice|ExtendedAmount|Discountable|AgeRestrictedFlag|CouponFlag|
|00004      |1111111111133|EAN-13    |1       |0143      |Item G       |アイテムのG     |2000.0               |0.0     |0.0           |2000.0              |2000.0        |True        |0                |0         |
Then promotion should have the following data :
|RewardID|EarnedRewardID|PromotionCode|DiscountDescription|ItemEntryID|UnitDiscountAmount|
|1|9896|9896|Proportion Distribution 3|00003|1090|
|2|9896|9896|Proportion Distribution 3|00004|1090|
|3|9896|9896|Proportion Distribution 3|00001|1079|
|4|9896|9896|Proportion Distribution 3|00002|737|
Then there should be revoke
!-- 4
When a Item Entry at promotion with parameters RetailStoreID{0031} WorkStationId{1111} SequenceNo{1} TransactionJson{{"Sale":{"ItemEntryID":"00005","ItemID":"1111111111133","ItemIDType":"EAN-13","Quantity":1}}}
Then the Result Code is 0
Then Sale data should be :
|ItemEntryID|ItemID       |ItemIDType|Quantity|Department|DescriptionEN|DescriptionJP|RegularSalesUnitPrice|Discount|DiscountAmount|ActualSalesUnitPrice|ExtendedAmount|Discountable|AgeRestrictedFlag|CouponFlag|
|00005      |1111111111133|EAN-13    |1       |0143      |Item G       |アイテムのG     |2000.0               |0.0     |0.0           |2000.0              |2000.0        |True        |0                |0         |
Then promotion should have the following data :
|RewardID|EarnedRewardID|PromotionCode|DiscountDescription|ItemEntryID|UnitDiscountAmount|
|1|9896|9896|Proportion Distribution 3|00003|1107|
|2|9896|9896|Proportion Distribution 3|00004|1107|
|3|9896|9896|Proportion Distribution 3|00005|1107|
|4|9896|9896|Proportion Distribution 3|00001|1095|
|5|9896|9896|Proportion Distribution 3|00002|746|
Then there should be revoke
!-- 5
When a Item Entry at promotion with parameters RetailStoreID{0031} WorkStationId{1111} SequenceNo{1} TransactionJson{{"Sale":{"ItemEntryID":"00006","ItemID":"1111111111133","ItemIDType":"EAN-13","Quantity":1}}}
Then the Result Code is 0
Then Sale data should be :
|ItemEntryID|ItemID       |ItemIDType|Quantity|Department|DescriptionEN|DescriptionJP|RegularSalesUnitPrice|Discount|DiscountAmount|ActualSalesUnitPrice|ExtendedAmount|Discountable|AgeRestrictedFlag|CouponFlag|
|00006      |1111111111133|EAN-13    |1       |0143      |Item G       |アイテムのG     |2000.0               |0.0     |0.0           |2000.0              |2000.0        |True        |0                |0         |
Then promotion should have the following data :
|RewardID|EarnedRewardID|PromotionCode|DiscountDescription|ItemEntryID|UnitDiscountAmount|
|1|9896|9896|Proportion Distribution 3|00003|1117|
|2|9896|9896|Proportion Distribution 3|00004|1117|
|3|9896|9896|Proportion Distribution 3|00005|1117|
|4|9896|9896|Proportion Distribution 3|00006|1117|
|5|9896|9896|Proportion Distribution 3|00001|1106|
|6|9896|9896|Proportion Distribution 3|00002|756|
Then there should be revoke

Scenario: Item Entry (proportional distribution II)
When a Begin Transaction at promotion with parameters RetailStoreID{0031} WorkStationId{1111} SequenceNo{1} TransactionJson{{"TransactionMode":"0","OperatorID": "0003","BeginDateTime":"2012-12-20T09:30:47.00"}}
When a Item Entry at promotion with parameters RetailStoreID{0031} WorkStationId{1111} SequenceNo{1} TransactionJson{{"Sale":{"ItemEntryID":"00001","ItemID":"1111111111131","ItemIDType":"EAN-13","Quantity":1}}}
Then the Result Code is 0
Then Sale data should be :
|ItemEntryID|ItemID       |ItemIDType|Quantity|Department|DescriptionEN|DescriptionJP|RegularSalesUnitPrice|Discount|DiscountAmount|ActualSalesUnitPrice|ExtendedAmount|Discountable|AgeRestrictedFlag|CouponFlag|
|00001      |1111111111131|EAN-13    |1       |0143      |Item A       |アイテムのA     |1980.0               |0.0     |0.0           |1980.0              |1980.0        |True        |1                |1         |
Then there should be no promotion data.
!-- 6
When a Item Entry at promotion with parameters RetailStoreID{0031} WorkStationId{1111} SequenceNo{1} TransactionJson{{"Sale":{"ItemEntryID":"00002","ItemID":"1111111111132","ItemIDType":"EAN-13","Quantity":1}}}
Then the Result Code is 0
Then Sale data should be :
|ItemEntryID|ItemID       |ItemIDType|Quantity|Department|DescriptionEN|DescriptionJP|RegularSalesUnitPrice|Discount|DiscountAmount|ActualSalesUnitPrice|ExtendedAmount|Discountable|AgeRestrictedFlag|CouponFlag|
|00002      |1111111111132|EAN-13    |1       |0143      |Item AA      |アイテムのAA    |1350.0               |0.0     |0.0           |1350.0              |1350.0        |True        |1                |0         |
Then there should be no promotion data.
!-- 7
When a Item Entry at promotion with parameters RetailStoreID{0031} WorkStationId{1111} SequenceNo{1} TransactionJson{{"Sale":{"ItemEntryID":"00003","ItemID":"1111111111133","ItemIDType":"EAN-13","Quantity":2}}}
Then the Result Code is 0
Then Sale data should be :
|ItemEntryID|ItemID       |ItemIDType|Quantity|Department|DescriptionEN|DescriptionJP|RegularSalesUnitPrice|Discount|DiscountAmount|ActualSalesUnitPrice|ExtendedAmount|Discountable|AgeRestrictedFlag|CouponFlag|
|00003      |1111111111133|EAN-13    |2       |0143      |Item G       |アイテムのG     |2000.0               |0.0     |0.0           |2000.0              |4000.0        |True        |0                |0         |
Then promotion should have the following data :
|RewardID|EarnedRewardID|PromotionCode|DiscountDescription|ItemEntryID|UnitDiscountAmount|
|1|9896|9896|Proportion Distribution 3|00003|2180|
|2|9896|9896|Proportion Distribution 3|00001|1079|
|3|9896|9896|Proportion Distribution 3|00002|737|
Then the JSON should have the following format :
{"Transaction":{"TransactionMode":0,"Sale":{"ItemID":"1111111111133","Department":"0143","Description":{"en":"Item G","jp":"アイテムのG"},"RegularSalesUnitPrice":2000.0,"Discount":0.0,"DiscountFlag":0,"DiscountAmount":0.0,"ActualSalesUnitPrice":2000.0,"Discountable":true,"TaxRate":0,"TaxType":0,"DiscountType":0,"NonSales":0,"SubInt10":0,"Line":"0143","Class":"000001","AgeRestrictedFlag":0,"CouponFlag":"0","EmpPrice1":2000.0,"PSType":"","OrgSalesPrice1":0.0,"ItemEntryID":"00003","ItemIDType":"EAN-13","Quantity":2,"ExtendedAmount":4000.0,"InputType":0},"EntryFlag":0},"Promotion":{"Discount":[{"RewardID":1,"EarnedRewardID":"9896","PromotionCode":"9896","DiscountDescription":"Proportion Distribution 3","ItemEntryID":"00003","UnitDiscountAmt":2180,"Quantity":2},{"RewardID":2,"EarnedRewardID":"9896","PromotionCode":"9896","DiscountDescription":"Proportion Distribution 3","ItemEntryID":"00001","UnitDiscountAmt":1079,"Quantity":1},{"RewardID":3,"EarnedRewardID":"9896","PromotionCode":"9896","DiscountDescription":"Proportion Distribution 3","ItemEntryID":"00002","UnitDiscountAmt":737,"Quantity":1}],"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0},"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0}
Then there should be no revoke
!-- 8
When a Item Entry at promotion with parameters RetailStoreID{0031} WorkStationId{1111} SequenceNo{1} TransactionJson{{"Sale":{"ItemEntryID":"00005","ItemID":"1111111111133","ItemIDType":"EAN-13","Quantity":1}}}
Then the Result Code is 0
Then Sale data should be :
|ItemEntryID|ItemID       |ItemIDType|Quantity|Department|DescriptionEN|DescriptionJP|RegularSalesUnitPrice|Discount|DiscountAmount|ActualSalesUnitPrice|ExtendedAmount|Discountable|AgeRestrictedFlag|CouponFlag|
|00005      |1111111111133|EAN-13    |1       |0143      |Item G       |アイテムのG     |2000.0               |0.0     |0.0           |2000.0              |2000.0        |True        |0                |0         |
Then promotion should have the following data :
|RewardID|EarnedRewardID|PromotionCode|DiscountDescription|ItemEntryID|UnitDiscountAmount|
|1|9896|9896|Proportion Distribution 3|00003|2214|
|2|9896|9896|Proportion Distribution 3|00005|1107|
|3|9896|9896|Proportion Distribution 3|00001|1095|
|4|9896|9896|Proportion Distribution 3|00002|746|
!-- 9
When a Item Entry at promotion with parameters RetailStoreID{0031} WorkStationId{1111} SequenceNo{1} TransactionJson{{"Sale":{"ItemEntryID":"00006","ItemID":"1111111111131","ItemIDType":"EAN-13","Quantity":1}}}
Then the Result Code is 0
Then Sale data should be :
|ItemEntryID|ItemID       |ItemIDType|Quantity|Department|DescriptionEN|DescriptionJP|RegularSalesUnitPrice|Discount|DiscountAmount|ActualSalesUnitPrice|ExtendedAmount|Discountable|AgeRestrictedFlag|CouponFlag|
|00006      |1111111111131|EAN-13    |1       |0143      |Item A       |アイテムのA     |1980.0               |0.0     |0.0           |1980.0              |1980.0        |True        |1                |1         |
Then promotion should have the following data :
|RewardID|EarnedRewardID|PromotionCode|DiscountDescription|ItemEntryID|UnitDiscountAmount|
|1|9896|9896|Proportion Distribution 3|00003|2232|
|2|9896|9896|Proportion Distribution 3|00005|1116|
|3|9896|9896|Proportion Distribution 3|00001|1105|
|4|9896|9896|Proportion Distribution 3|00006|1105|
|5|9896|9896|Proportion Distribution 3|00002|752|
Then there should be revoke