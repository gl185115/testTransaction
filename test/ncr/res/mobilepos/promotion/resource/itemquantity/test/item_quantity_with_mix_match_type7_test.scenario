Scenario: Test Item Entry & Quantity with MixMatch Type 7
When the Web API Starts Up
Given a Promotion Service
Given a loaded dataset {items_for_mixmatch.xml}
Given a loaded dataset {mixmatch_promotions.xml}

!-- Add a single item (EntryID:00001, qty: 1)
When a Begin Transaction at promotion with parameters RetailStoreID{0031} WorkStationId{1111} SequenceNo{1} TransactionJson{{"TransactionMode":"0","OperatorID": "0003","BeginDateTime":"2012-12-20T09:30:47.00"}}
When a Item Entry at promotion with parameters RetailStoreID{0031} WorkStationId{1111} SequenceNo{1} TransactionJson{{"Sale":{"ItemEntryID":"00001","ItemID":"8865545775637","ItemIDType":"EAN-13","Quantity":1}}}
Then Sale data should be :
|ItemEntryID|ItemID       |ItemIDType|Quantity|Department|Description     |RegularSalesUnitPrice|Discount|DiscountAmount|ActualSalesUnitPrice|ExtendedAmount|Discountable|
|00001      |8865545775637|EAN-13    |1       |0143      |sample product 7|100.0                |0%      |0.0           |100.0               |100.0         |True        |

Scenario: Item ADD Update (EntryID:00001, qty: 2) but was no Mix Match triggered
When I request to update Item Quantity at promotion with parameters RetailStoreID{0031} WorkStationID{1111} SequenceNo{1} and TransactionJson{{"EntryFlag": 2,"Sale":{"ItemEntryID":"00001","Quantity":"1"}}}
Then there should be no Discount promotion data for update quantity.
Then the JSON should have the following format : {"Promotion":{"Discount":[],"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0},"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0}

Scenario: Item ADD Update (EntryID:00001, qty: 3) and Mix Match triggered, Revoke is not expected.
When I request to update Item Quantity at promotion with parameters RetailStoreID{0031} WorkStationID{1111} SequenceNo{1} and TransactionJson{{"EntryFlag": 2,"Sale":{"ItemEntryID":"00001","Quantity":"1"}}}
Then promotion should have the following data for update quantity:
|RewardID|EarnedRewardID|PromotionCode|DiscountDescription  |ItemEntryID|UnitDiscountAmount|
|1       |1007          |1007         |Mix Match 1007 Type 7|00001      |36                |
Then the JSON should have the following format : {"Promotion":{"Discount":[{"RewardID":1,"EarnedRewardID":"1007","PromotionCode":"1007","DiscountDescription":"Mix Match 1007 Type 7","ItemEntryID":"00001","UnitDiscountAmt":36,"Quantity":3}],"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0},"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0}

Scenario: Additional Item ADD Update (EntryID:00001, qty: 4) and Mix Match triggered, Revoke is now expected.
When I request to update Item Quantity at promotion with parameters RetailStoreID{0031} WorkStationID{1111} SequenceNo{1} and TransactionJson{{"EntryFlag": 2,"Sale":{"ItemEntryID":"00001","Quantity":"1"}}}
Then promotion should have the following data for update quantity:
|RewardID|EarnedRewardID|PromotionCode|DiscountDescription  |ItemEntryID|UnitDiscountAmount|
|1       |1007          |1007         |Mix Match 1007 Type 7|00001      |48                |
Then the JSON should have the following format : {"Promotion":{"Discount":[{"RewardID":1,"EarnedRewardID":"1007","PromotionCode":"1007","DiscountDescription":"Mix Match 1007 Type 7","ItemEntryID":"00001","UnitDiscountAmt":48,"Quantity":4}],"Revoke":{"EarnedRewardID":"1007"},"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0},"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0}

Scenario: Additional Item ADD Update (EntryID:00001, qty: 6) and Mix Match triggered, Revoke is now expected.
When I request to update Item Quantity at promotion with parameters RetailStoreID{0031} WorkStationID{1111} SequenceNo{1} and TransactionJson{{"EntryFlag": 2,"Sale":{"ItemEntryID":"00001","Quantity":"2"}}}
Then promotion should have the following data for update quantity:
|RewardID|EarnedRewardID|PromotionCode|DiscountDescription  |ItemEntryID|UnitDiscountAmount|
|1       |1007          |1007         |Mix Match 1007 Type 7|00001      |72                |
Then the JSON should have the following format : {"Promotion":{"Discount":[{"RewardID":1,"EarnedRewardID":"1007","PromotionCode":"1007","DiscountDescription":"Mix Match 1007 Type 7","ItemEntryID":"00001","UnitDiscountAmt":72,"Quantity":6}],"Revoke":{"EarnedRewardID":"1007"},"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0},"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0}

Scenario: Item ADD Update  for other item (EntryID:00001, qty: 6 | EntryID:00002, qty: 3) and Mix Match triggered, Revoke is expected.
When a Item Entry at promotion with parameters RetailStoreID{0031} WorkStationId{1111} SequenceNo{1} TransactionJson{{"Sale":{"ItemEntryID":"00002","ItemID":"8865545775638","ItemIDType":"EAN-13","Quantity":1}}}
Then Sale data should be :
|ItemEntryID|ItemID       |ItemIDType|Quantity|Department|Description     |RegularSalesUnitPrice|Discount|DiscountAmount|ActualSalesUnitPrice|ExtendedAmount|Discountable|
|00002      |8865545775638|EAN-13    |1       |0143      |sample product 8|90.0                 |0%      |0.0           |90.0                |90.0          |True        |
Then promotion should have the following data :
|RewardID|EarnedRewardID|PromotionCode|DiscountDescription  |ItemEntryID|UnitDiscountAmount|
|1       |1007          |1007         |Mix Match 1007 Type 7|00001      |72                |
|2       |1007          |1007         |Mix Match 1007 Type 7|00002      |10                |
When I request to update Item Quantity at promotion with parameters RetailStoreID{0031} WorkStationID{1111} SequenceNo{1} and TransactionJson{{"EntryFlag": 2,"Sale":{"ItemEntryID":"00002","Quantity":"2"}}}
Then promotion should have the following data for update quantity:
|RewardID|EarnedRewardID|PromotionCode|DiscountDescription  |ItemEntryID|UnitDiscountAmount|
|1       |1007          |1007         |Mix Match 1007 Type 7|00001      |72                |
|2       |1007          |1007         |Mix Match 1007 Type 7|00002      |32                |
Then the JSON should have the following format : {"Promotion":{"Discount":[{"RewardID":1,"EarnedRewardID":"1007","PromotionCode":"1007","DiscountDescription":"Mix Match 1007 Type 7","ItemEntryID":"00001","UnitDiscountAmt":72,"Quantity":6},{"RewardID":2,"EarnedRewardID":"1007","PromotionCode":"1007","DiscountDescription":"Mix Match 1007 Type 7","ItemEntryID":"00002","UnitDiscountAmt":32,"Quantity":3}],"Revoke":{"EarnedRewardID":"1007"},"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0},"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0}

Scenario: Add third Item with higher price than the previous added item (EntryID:00001, qty: 6 | EntryID:00002, qty: 3 | EntryID:00003, qty: 1)
When a Item Entry at promotion with parameters RetailStoreID{0031} WorkStationId{1111} SequenceNo{1} TransactionJson{{"Sale":{"ItemEntryID":"00003","ItemID":"8865545775637","ItemIDType":"EAN-13","Quantity":1}}}
Then Sale data should be :
|ItemEntryID|ItemID       |ItemIDType|Quantity|Department|Description     |RegularSalesUnitPrice|Discount|DiscountAmount|ActualSalesUnitPrice|ExtendedAmount|Discountable|
|00003      |8865545775637|EAN-13    |1       |0143      |sample product 7|100.0                 |0%      |0.0           |100.0                |100.0          |True        |
Then promotion should have the following data for update quantity:
|RewardID|EarnedRewardID|PromotionCode|DiscountDescription  |ItemEntryID|UnitDiscountAmount|
|1       |1007          |1007         |Mix Match 1007 Type 7|00001      |72                |
|2       |1007          |1007         |Mix Match 1007 Type 7|00003      |12                |
|3       |1007          |1007         |Mix Match 1007 Type 7|00002      |33                |
Then the JSON should have the following format : {"Transaction":{"TransactionMode":0,"Sale":{"ItemID":"8865545775637","ItemEntryID":"00003","ItemIDType":"EAN-13","Quantity":1,"Department":"0143","Description":"sample product 7","RegularSalesUnitPrice":100.0,"Discount":"0%","DiscountAmount":0.0,"ActualSalesUnitPrice":100.0,"ExtendedAmount":100.0,"Discountable":true,"TaxRate":"0%","TaxType":0,"DiscountType":0,"NonSales":0,"SubInt10":0,"InputType":0,"Line":"0143","Class":"000001"},"EntryFlag":0},"Promotion":{"Discount":[{"RewardID":1,"EarnedRewardID":"1007","PromotionCode":"1007","DiscountDescription":"Mix Match 1007 Type 7","ItemEntryID":"00001","UnitDiscountAmt":72,"Quantity":6},{"RewardID":2,"EarnedRewardID":"1007","PromotionCode":"1007","DiscountDescription":"Mix Match 1007 Type 7","ItemEntryID":"00003","UnitDiscountAmt":12,"Quantity":1},{"RewardID":3,"EarnedRewardID":"1007","PromotionCode":"1007","DiscountDescription":"Mix Match 1007 Type 7","ItemEntryID":"00002","UnitDiscountAmt":33,"Quantity":3}],"Revoke":{"EarnedRewardID":"1007"},"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0},"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0}

Scenario: Item REMOVE Update  for third item (EntryID:00001, qty: 6 | EntryID:00002, qty: 3) and 2 Mix Match triggered, Revoke is now expected.
When I request to update Item Quantity at promotion with parameters RetailStoreID{0031} WorkStationID{1111} SequenceNo{1} and TransactionJson{{"EntryFlag": 0,"Sale":{"ItemEntryID":"00003","Quantity":"1"}}}
Then promotion should have the following data for update quantity:
|RewardID|EarnedRewardID|PromotionCode|DiscountDescription  |ItemEntryID|UnitDiscountAmount|
|1       |1007          |1007         |Mix Match 1007 Type 7|00001      |72                |
|2       |1007          |1007         |Mix Match 1007 Type 7|00002      |32                |
Then the JSON should have the following format : {"Promotion":{"Discount":[{"RewardID":1,"EarnedRewardID":"1007","PromotionCode":"1007","DiscountDescription":"Mix Match 1007 Type 7","ItemEntryID":"00001","UnitDiscountAmt":72,"Quantity":6},{"RewardID":2,"EarnedRewardID":"1007","PromotionCode":"1007","DiscountDescription":"Mix Match 1007 Type 7","ItemEntryID":"00002","UnitDiscountAmt":32,"Quantity":3}],"Revoke":{"EarnedRewardID":"1007"},"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0},"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0}

Scenario: Item REMOVE Update  for other item (EntryID:00001, qty: 4 | EntryID:00002, qty: 3) and 2 Mix Match triggered, Revoke is now expected.
When I request to update Item Quantity at promotion with parameters RetailStoreID{0031} WorkStationID{1111} SequenceNo{1} and TransactionJson{{"EntryFlag": 0,"Sale":{"ItemEntryID":"00001","Quantity":"2"}}}
Then promotion should have the following data for update quantity:
|RewardID|EarnedRewardID|PromotionCode|DiscountDescription  |ItemEntryID|UnitDiscountAmount|
|1       |1007          |1007         |Mix Match 1007 Type 7|00001      |48                |
|2       |1007          |1007         |Mix Match 1007 Type 7|00002      |32                |
Then the JSON should have the following format : {"Promotion":{"Discount":[{"RewardID":1,"EarnedRewardID":"1007","PromotionCode":"1007","DiscountDescription":"Mix Match 1007 Type 7","ItemEntryID":"00001","UnitDiscountAmt":48,"Quantity":4},{"RewardID":2,"EarnedRewardID":"1007","PromotionCode":"1007","DiscountDescription":"Mix Match 1007 Type 7","ItemEntryID":"00002","UnitDiscountAmt":32,"Quantity":3}],"Revoke":{"EarnedRewardID":"1007"},"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0},"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0}

Scenario: Item REMOVE Update  for other item (EntryID:00001, qty: 2 | EntryID:00002, qty: 3) and 1 Mix Match triggered, Revoke is now expected.
!-- 00001, 200         24
!-- 00002, 90          11 - 1(excess) ~ 10
!--	----------------------
!--        290 x 12% = 34
!-- 00002, 90 + 290 = 380 x 12% = 45 - 34 = 11
!-- 00002, 90 + 380 = 470 x 12% = 56 - 34 - 11 = 11
!-- 00002, (10 + 11 + 11) = 32 *Final UnitDiscount of 00002
When I request to update Item Quantity at promotion with parameters RetailStoreID{0031} WorkStationID{1111} SequenceNo{1} and TransactionJson{{"EntryFlag": 0,"Sale":{"ItemEntryID":"00001","Quantity":"2"}}}
Then promotion should have the following data for update quantity:
|RewardID|EarnedRewardID|PromotionCode|DiscountDescription  |ItemEntryID|UnitDiscountAmount|
|1       |1007          |1007         |Mix Match 1007 Type 7|00001      |24                |
|2       |1007          |1007         |Mix Match 1007 Type 7|00002      |32                |
Then the JSON should have the following format : {"Promotion":{"Discount":[{"RewardID":1,"EarnedRewardID":"1007","PromotionCode":"1007","DiscountDescription":"Mix Match 1007 Type 7","ItemEntryID":"00001","UnitDiscountAmt":24,"Quantity":2},{"RewardID":2,"EarnedRewardID":"1007","PromotionCode":"1007","DiscountDescription":"Mix Match 1007 Type 7","ItemEntryID":"00002","UnitDiscountAmt":32,"Quantity":3}],"Revoke":{"EarnedRewardID":"1007"},"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0},"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0}

Scenario: Item REMOVE Update  for other item (EntryID:00002, qty: 3) and 1 Mix Match triggered, Revoke is now expected.
When I request to update Item Quantity at promotion with parameters RetailStoreID{0031} WorkStationID{1111} SequenceNo{1} and TransactionJson{{"EntryFlag": 0,"Sale":{"ItemEntryID":"00001","Quantity":"2"}}}
Then promotion should have the following data for update quantity:
|RewardID|EarnedRewardID|PromotionCode|DiscountDescription  |ItemEntryID|UnitDiscountAmount|
|1       |1007          |1007         |Mix Match 1007 Type 7|00002      |32                |
Then the JSON should have the following format : {"Promotion":{"Discount":[{"RewardID":1,"EarnedRewardID":"1007","PromotionCode":"1007","DiscountDescription":"Mix Match 1007 Type 7","ItemEntryID":"00002","UnitDiscountAmt":32,"Quantity":3}],"Revoke":{"EarnedRewardID":"1007"},"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0},"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0}

Scenario: Item REMOVE Update  for other item (EntryID:00002, qty: 2) and No Mix Match triggered, Revoke is still expected.
When I request to update Item Quantity at promotion with parameters RetailStoreID{0031} WorkStationID{1111} SequenceNo{1} and TransactionJson{{"EntryFlag": 0,"Sale":{"ItemEntryID":"00002","Quantity":"1"}}}
Then there should be no Discount promotion data for update quantity.
Then the JSON should have the following format : {"Promotion":{"Discount":[],"Revoke":{"EarnedRewardID":"1007"},"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0},"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0}

Scenario: Item REMOVE ALL item  for other item (No Item Entry) and No Mix Match triggered, Revoke is no more expected.
When I request to update Item Quantity at promotion with parameters RetailStoreID{0031} WorkStationID{1111} SequenceNo{1} and TransactionJson{{"EntryFlag": 0,"Sale":{"ItemEntryID":"00002","Quantity":"2"}}}
Then there should be no Discount promotion data for update quantity.
Then the JSON should have the following format : {"Promotion":{"Discount":[],"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0},"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0}

When I request to update Item Quantity at promotion with parameters RetailStoreID{0031} WorkStationID{1111} SequenceNo{1} and TransactionJson{{"EntryFlag": 0,"Sale":{"ItemEntryID":"00002","Quantity":"2"}}}
Then there should be no Discount promotion data for update quantity.
Then the Result Code is 1110

When I request to update Item Quantity at promotion with parameters RetailStoreID{0031} WorkStationID{1111} SequenceNo{1} and TransactionJson{{"EntryFlag": 2,"Sale":{"ItemEntryID":"00002","Quantity":"2"}}}
Then there should be no Discount promotion data for update quantity.
Then the Result Code is 1110