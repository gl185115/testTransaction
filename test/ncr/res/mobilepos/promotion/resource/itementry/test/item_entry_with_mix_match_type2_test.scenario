Scenario: Test Item Entry with MixMatch Type 1
When the Web API Starts Up
Given a Promotion Service
Given a loaded dataset {items_for_mixmatch.xml}
Given a loaded dataset {mixmatch_promotions.xml}

Scenario: Item Entry (same items, different item entry id, 1st step discount) 
When a Begin Transaction at promotion with parameters RetailStoreID{0031} WorkStationId{1111} SequenceNo{1} TransactionJson{{"TransactionMode":"0","OperatorID": "0003","BeginDateTime":"2012-12-20T09:30:47.00"}}
When a Item Entry at promotion with parameters RetailStoreID{0031} WorkStationId{1111} SequenceNo{1} TransactionJson{{"Sale":{"ItemEntryID":"00001","ItemID":"8865545775641","ItemIDType":"EAN-13","Quantity":1}}}
Then the Result Code is 0
Then Sale data should be :
|ItemEntryID|ItemID       |ItemIDType|Quantity|Department|DescriptionEN   |DescriptionJP   |RegularSalesUnitPrice|Discount|DiscountAmount|ActualSalesUnitPrice|ExtendedAmount|Discountable|AgeRestrictedFlag|CouponFlag|
|00001      |8865545775641|EAN-13    |1       |0143      |sample product 1|サンプル製品1      |100.0                |0.0     |0.0           |100.0               |100.0         |True        |1                |0         |
Then there should be no promotion data.
When a Item Entry at promotion with parameters RetailStoreID{0031} WorkStationId{1111} SequenceNo{1} TransactionJson{{"Sale":{"ItemEntryID":"00002","ItemID":"8865545775641","ItemIDType":"EAN-13","Quantity":1}}}
Then the Result Code is 0
Then Sale data should be :
|ItemEntryID|ItemID       |ItemIDType|Quantity|Department|DescriptionEN   |DescriptionJP   |RegularSalesUnitPrice|Discount|DiscountAmount|ActualSalesUnitPrice|ExtendedAmount|Discountable|AgeRestrictedFlag|CouponFlag|
|00002      |8865545775641|EAN-13    |1       |0143      |sample product 1|サンプル製品1      |100.0                |0.0     |0.0           |100.0               |100.0         |True        |1                |0         |
Then promotion should have the following data :
|RewardID|EarnedRewardID|PromotionCode|DiscountDescription|ItemEntryID|UnitDiscountAmount|
|1|1112|1112|Mix Match 1111 Type 2|00002|10|
|2|1112|1112|Mix Match 1111 Type 2|00001|10|
Then the JSON should have the following format :
{"Transaction":{"TransactionMode":0,"Sale":{"ItemID":"8865545775641","Department":"0143","Description":{"en":"sample product 1","jp":"サンプル製品1"},"RegularSalesUnitPrice":100.0,"Discount":0.0,"DiscountFlag":0,"DiscountAmount":0.0,"ActualSalesUnitPrice":100.0,"Discountable":true,"TaxRate":0,"TaxType":0,"DiscountType":0,"NonSales":0,"SubInt10":0,"Line":"0143","Class":"000001","AgeRestrictedFlag":1,"CouponFlag":"0","EmpPrice1":100.0,"PSType":"","OrgSalesPrice1":0.0,"ItemEntryID":"00002","ItemIDType":"EAN-13","Quantity":1,"ExtendedAmount":100.0,"InputType":0},"EntryFlag":0},"Promotion":{"Discount":[{"RewardID":1,"EarnedRewardID":"1112","PromotionCode":"1112","DiscountDescription":"Mix Match 1111 Type 2","ItemEntryID":"00002","UnitDiscountAmt":10,"Quantity":1},{"RewardID":2,"EarnedRewardID":"1112","PromotionCode":"1112","DiscountDescription":"Mix Match 1111 Type 2","ItemEntryID":"00001","UnitDiscountAmt":10,"Quantity":1}],"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0},"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0}
Then there should be no revoke

Scenario: Item Entry (same items, different item entry id, continue to 2nd step discount)
When a Item Entry at promotion with parameters RetailStoreID{0031} WorkStationId{1111} SequenceNo{1} TransactionJson{{"Sale":{"ItemEntryID":"00003","ItemID":"8865545775641","ItemIDType":"EAN-13","Quantity":1}}}
Then the Result Code is 0
Then Sale data should be :
|ItemEntryID|ItemID       |ItemIDType|Quantity|Department|DescriptionEN   |DescriptionJP   |RegularSalesUnitPrice|Discount|DiscountAmount|ActualSalesUnitPrice|ExtendedAmount|Discountable|AgeRestrictedFlag|CouponFlag|
|00003      |8865545775641|EAN-13    |1       |0143      |sample product 1|サンプル製品1      |100.0                |0.0     |0.0           |100.0               |100.0         |True        |1                |0         |
Then promotion should have the following data :
|RewardID|EarnedRewardID|PromotionCode|DiscountDescription|ItemEntryID|UnitDiscountAmount|
|1|1112|1112|Mix Match 1111 Type 2|00003|17|
|2|1112|1112|Mix Match 1111 Type 2|00002|17|
|3|1112|1112|Mix Match 1111 Type 2|00001|16|
Then there should be revoke

Scenario: Item Entry (same items, one item entry id, 1st step discount) 
When a Begin Transaction at promotion with parameters RetailStoreID{0031} WorkStationId{1111} SequenceNo{1} TransactionJson{{"TransactionMode":"0","OperatorID": "0003","BeginDateTime":"2012-12-20T09:30:47.00"}}
When a Item Entry at promotion with parameters RetailStoreID{0031} WorkStationId{1111} SequenceNo{1} TransactionJson{{"Sale":{"ItemEntryID":"00001","ItemID":"8865545775641","ItemIDType":"EAN-13","Quantity":2}}}
Then the Result Code is 0
Then Sale data should be :
|ItemEntryID|ItemID       |ItemIDType|Quantity|Department|DescriptionEN   |DescriptionJP   |RegularSalesUnitPrice|Discount|DiscountAmount|ActualSalesUnitPrice|ExtendedAmount|Discountable|AgeRestrictedFlag|CouponFlag|
|00001      |8865545775641|EAN-13    |2       |0143      |sample product 1|サンプル製品1      |100.0                |0.0     |0.0           |100.0               |200.0         |True        |1                |0         |
Then promotion should have the following data :
|RewardID|EarnedRewardID|PromotionCode|DiscountDescription|ItemEntryID|UnitDiscountAmount|
|1|1112|1112|Mix Match 1111 Type 2|00001|20|
Then the JSON should have the following format :
{"Transaction":{"TransactionMode":0,"Sale":{"ItemID":"8865545775641","Department":"0143","Description":{"en":"sample product 1","jp":"サンプル製品1"},"RegularSalesUnitPrice":100.0,"Discount":0.0,"DiscountFlag":0,"DiscountAmount":0.0,"ActualSalesUnitPrice":100.0,"Discountable":true,"TaxRate":0,"TaxType":0,"DiscountType":0,"NonSales":0,"SubInt10":0,"Line":"0143","Class":"000001","AgeRestrictedFlag":1,"CouponFlag":"0","EmpPrice1":100.0,"PSType":"","OrgSalesPrice1":0.0,"ItemEntryID":"00001","ItemIDType":"EAN-13","Quantity":2,"ExtendedAmount":200.0,"InputType":0},"EntryFlag":0},"Promotion":{"Discount":[{"RewardID":1,"EarnedRewardID":"1112","PromotionCode":"1112","DiscountDescription":"Mix Match 1111 Type 2","ItemEntryID":"00001","UnitDiscountAmt":20,"Quantity":2}],"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0},"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0}
Then there should be no revoke

Scenario: Item Entry (same items, different item entry id, continue to 2nd step discount)
When a Item Entry at promotion with parameters RetailStoreID{0031} WorkStationId{1111} SequenceNo{1} TransactionJson{{"Sale":{"ItemEntryID":"00002","ItemID":"8865545775651","ItemIDType":"EAN-13","Quantity":1}}}
Then the Result Code is 0
Then Sale data should be :
|ItemEntryID|ItemID       |ItemIDType|Quantity|Department|DescriptionEN     |DescriptionJP     |RegularSalesUnitPrice|Discount|DiscountAmount|ActualSalesUnitPrice|ExtendedAmount|Discountable|AgeRestrictedFlag|CouponFlag|
|00002      |8865545775651|EAN-13    |1       |0143      |sample product 1.1|サンプル製品1.1      |130.0                |0.0     |0.0           |130.0               |130.0         |True        |1                |null      |
Then promotion should have the following data :
|RewardID|EarnedRewardID|PromotionCode|DiscountDescription|ItemEntryID|UnitDiscountAmount|
|1|1112|1112|Mix Match 1111 Type 2|00002|32|
|2|1112|1112|Mix Match 1111 Type 2|00001|48|
Then there should be revoke

Scenario: Item Entry (same items, one item entry id, direct 2nd step discount) 
When a Begin Transaction at promotion with parameters RetailStoreID{0031} WorkStationId{1111} SequenceNo{1} TransactionJson{{"TransactionMode":"0","OperatorID": "0003","BeginDateTime":"2012-12-20T09:30:47.00"}}
When a Item Entry at promotion with parameters RetailStoreID{0031} WorkStationId{1111} SequenceNo{1} TransactionJson{{"Sale":{"ItemEntryID":"00001","ItemID":"8865545775651","ItemIDType":"EAN-13","Quantity":3}}}
Then the Result Code is 0
Then Sale data should be :
|ItemEntryID|ItemID       |ItemIDType|Quantity|Department|DescriptionEN     |DescriptionJP     |RegularSalesUnitPrice|Discount|DiscountAmount|ActualSalesUnitPrice|ExtendedAmount|Discountable|AgeRestrictedFlag|CouponFlag|
|00001      |8865545775651|EAN-13    |3       |0143      |sample product 1.1|サンプル製品1.1      |130.0                |0.0     |0.0           |130.0               |390.0         |True        |1                |null      |
Then promotion should have the following data :
|RewardID|EarnedRewardID|PromotionCode|DiscountDescription|ItemEntryID|UnitDiscountAmount|
|1|1112|1112|Mix Match 1111 Type 2|00001|140|
Then the JSON should have the following format :
{"Transaction":{"TransactionMode":0,"Sale":{"ItemID":"8865545775651","Department":"0143","Description":{"en":"sample product 1.1","jp":"サンプル製品1.1"},"RegularSalesUnitPrice":130.0,"Discount":0.0,"DiscountFlag":0,"DiscountAmount":0.0,"ActualSalesUnitPrice":130.0,"Discountable":true,"TaxRate":0,"TaxType":0,"DiscountType":0,"NonSales":0,"SubInt10":0,"Line":"0143","Class":"000001","AgeRestrictedFlag":1,"EmpPrice1":130.0,"PSType":"","OrgSalesPrice1":0.0,"ItemEntryID":"00001","ItemIDType":"EAN-13","Quantity":3,"ExtendedAmount":390.0,"InputType":0},"EntryFlag":0},"Promotion":{"Discount":[{"RewardID":1,"EarnedRewardID":"1112","PromotionCode":"1112","DiscountDescription":"Mix Match 1111 Type 2","ItemEntryID":"00001","UnitDiscountAmt":140,"Quantity":3}],"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0},"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0}
Then there should be no revoke

Scenario: Item Entry (same items, one item entry id, continue to 1st step discount)
When a Item Entry at promotion with parameters RetailStoreID{0031} WorkStationId{1111} SequenceNo{1} TransactionJson{{"Sale":{"ItemEntryID":"00002","ItemID":"8865545775641","ItemIDType":"EAN-13","Quantity":2}}}
Then the Result Code is 0
Then Sale data should be :
|ItemEntryID|ItemID       |ItemIDType|Quantity|Department|DescriptionEN   |DescriptionJP   |RegularSalesUnitPrice|Discount|DiscountAmount|ActualSalesUnitPrice|ExtendedAmount|Discountable|AgeRestrictedFlag|CouponFlag|
|00002      |8865545775641|EAN-13    |2       |0143      |sample product 1|サンプル製品1      |100.0                |0.0     |0.0           |100.0               |200.0         |True        |1                |0         |
Then promotion should have the following data :
|RewardID|EarnedRewardID|PromotionCode|DiscountDescription|ItemEntryID|UnitDiscountAmount|
|1|1112|1112|Mix Match 1111 Type 2|00001|140|
|2|1112|1112|Mix Match 1111 Type 2|00002|20|
Then the JSON should have the following format :
{"Transaction":{"TransactionMode":0,"Sale":{"ItemID":"8865545775641","Department":"0143","Description":{"en":"sample product 1","jp":"サンプル製品1"},"RegularSalesUnitPrice":100.0,"Discount":0.0,"DiscountFlag":0,"DiscountAmount":0.0,"ActualSalesUnitPrice":100.0,"Discountable":true,"TaxRate":0,"TaxType":0,"DiscountType":0,"NonSales":0,"SubInt10":0,"Line":"0143","Class":"000001","AgeRestrictedFlag":1,"CouponFlag":"0","EmpPrice1":100.0,"PSType":"","OrgSalesPrice1":0.0,"ItemEntryID":"00002","ItemIDType":"EAN-13","Quantity":2,"ExtendedAmount":200.0,"InputType":0},"EntryFlag":0},"Promotion":{"Discount":[{"RewardID":1,"EarnedRewardID":"1112","PromotionCode":"1112","DiscountDescription":"Mix Match 1111 Type 2","ItemEntryID":"00001","UnitDiscountAmt":140,"Quantity":3},{"RewardID":2,"EarnedRewardID":"1112","PromotionCode":"1112","DiscountDescription":"Mix Match 1111 Type 2","ItemEntryID":"00002","UnitDiscountAmt":20,"Quantity":2}],"Revoke":{"EarnedRewardID":"1112"},"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0},"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0}
Then there should be revoke

Scenario: Item Entry (same items, one item entry id, direct 2nd step discount, with excess) 
When a Begin Transaction at promotion with parameters RetailStoreID{0031} WorkStationId{1111} SequenceNo{1} TransactionJson{{"TransactionMode":"0","OperatorID": "0003","BeginDateTime":"2012-12-20T09:30:47.00"}}
When a Item Entry at promotion with parameters RetailStoreID{0031} WorkStationId{1111} SequenceNo{1} TransactionJson{{"Sale":{"ItemEntryID":"00001","ItemID":"8865545775651","ItemIDType":"EAN-13","Quantity":4}}}
Then the Result Code is 0
Then Sale data should be :
|ItemEntryID|ItemID       |ItemIDType|Quantity|Department|DescriptionEN     |DescriptionJP     |RegularSalesUnitPrice|Discount|DiscountAmount|ActualSalesUnitPrice|ExtendedAmount|Discountable|AgeRestrictedFlag|CouponFlag|
|00001      |8865545775651|EAN-13    |4       |0143      |sample product 1.1|サンプル製品1.1      |130.0                |0.0     |0.0           |130.0               |520.0         |True        |1                |null      |
Then promotion should have the following data :
|RewardID|EarnedRewardID|PromotionCode|DiscountDescription|ItemEntryID|UnitDiscountAmount|
|1|1112|1112|Mix Match 1111 Type 2|00001|140|
Then the JSON should have the following format :
{"Transaction":{"TransactionMode":0,"Sale":{"ItemID":"8865545775651","Department":"0143","Description":{"en":"sample product 1.1","jp":"サンプル製品1.1"},"RegularSalesUnitPrice":130.0,"Discount":0.0,"DiscountFlag":0,"DiscountAmount":0.0,"ActualSalesUnitPrice":130.0,"Discountable":true,"TaxRate":0,"TaxType":0,"DiscountType":0,"NonSales":0,"SubInt10":0,"Line":"0143","Class":"000001","AgeRestrictedFlag":1,"EmpPrice1":130.0,"PSType":"","OrgSalesPrice1":0.0,"ItemEntryID":"00001","ItemIDType":"EAN-13","Quantity":4,"ExtendedAmount":520.0,"InputType":0},"EntryFlag":0},"Promotion":{"Discount":[{"RewardID":1,"EarnedRewardID":"1112","PromotionCode":"1112","DiscountDescription":"Mix Match 1111 Type 2","ItemEntryID":"00001","UnitDiscountAmt":140,"Quantity":3}],"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0},"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0}
Then there should be no revoke

Scenario: Item Entry (same items, one item entry id, continue to 1st step discount, use excess from previous)
When a Item Entry at promotion with parameters RetailStoreID{0031} WorkStationId{1111} SequenceNo{1} TransactionJson{{"Sale":{"ItemEntryID":"00002","ItemID":"8865545775641","ItemIDType":"EAN-13","Quantity":1}}}
Then the Result Code is 0
Then Sale data should be :
|ItemEntryID|ItemID       |ItemIDType|Quantity|Department|DescriptionEN   |DescriptionJP   |RegularSalesUnitPrice|Discount|DiscountAmount|ActualSalesUnitPrice|ExtendedAmount|Discountable|AgeRestrictedFlag|CouponFlag|
|00002      |8865545775641|EAN-13    |1       |0143      |sample product 1|サンプル製品1      |100.0                |0.0     |0.0           |100.0               |100.0         |True        |1                |0         |
Then promotion should have the following data :
|RewardID|EarnedRewardID|PromotionCode|DiscountDescription|ItemEntryID|UnitDiscountAmount|
|1|1112|1112|Mix Match 1111 Type 2|00001|140|
|2|1112|1112|Mix Match 1111 Type 2|00001|28|
|3|1112|1112|Mix Match 1111 Type 2|00002|22|
Then the JSON should have the following format :
{"Transaction":{"TransactionMode":0,"Sale":{"ItemID":"8865545775641","Department":"0143","Description":{"en":"sample product 1","jp":"サンプル製品1"},"RegularSalesUnitPrice":100.0,"Discount":0.0,"DiscountFlag":0,"DiscountAmount":0.0,"ActualSalesUnitPrice":100.0,"Discountable":true,"TaxRate":0,"TaxType":0,"DiscountType":0,"NonSales":0,"SubInt10":0,"Line":"0143","Class":"000001","AgeRestrictedFlag":1,"CouponFlag":"0","EmpPrice1":100.0,"PSType":"","OrgSalesPrice1":0.0,"ItemEntryID":"00002","ItemIDType":"EAN-13","Quantity":1,"ExtendedAmount":100.0,"InputType":0},"EntryFlag":0},"Promotion":{"Discount":[{"RewardID":1,"EarnedRewardID":"1112","PromotionCode":"1112","DiscountDescription":"Mix Match 1111 Type 2","ItemEntryID":"00001","UnitDiscountAmt":140,"Quantity":3},{"RewardID":2,"EarnedRewardID":"1112","PromotionCode":"1112","DiscountDescription":"Mix Match 1111 Type 2","ItemEntryID":"00001","UnitDiscountAmt":28,"Quantity":1},{"RewardID":3,"EarnedRewardID":"1112","PromotionCode":"1112","DiscountDescription":"Mix Match 1111 Type 2","ItemEntryID":"00002","UnitDiscountAmt":22,"Quantity":1}],"Revoke":{"EarnedRewardID":"1112"},"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0},"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0}
Then there should be revoke

Scenario: Item Entry (same items, one item entry id, direct 2nd step discount, with excess) 
When a Begin Transaction at promotion with parameters RetailStoreID{0031} WorkStationId{1111} SequenceNo{1} TransactionJson{{"TransactionMode":"0","OperatorID": "0003","BeginDateTime":"2012-12-20T09:30:47.00"}}
When a Item Entry at promotion with parameters RetailStoreID{0031} WorkStationId{1111} SequenceNo{1} TransactionJson{{"Sale":{"ItemEntryID":"00001","ItemID":"8865545775651","ItemIDType":"EAN-13","Quantity":4}}}
Then the Result Code is 0
Then Sale data should be :
|ItemEntryID|ItemID       |ItemIDType|Quantity|Department|DescriptionEN     |DescriptionJP     |RegularSalesUnitPrice|Discount|DiscountAmount|ActualSalesUnitPrice|ExtendedAmount|Discountable|AgeRestrictedFlag|CouponFlag|
|00001      |8865545775651|EAN-13    |4       |0143      |sample product 1.1|サンプル製品1.1      |130.0                |0.0     |0.0           |130.0               |520.0         |True        |1                |null      |
Then promotion should have the following data :
|RewardID|EarnedRewardID|PromotionCode|DiscountDescription|ItemEntryID|UnitDiscountAmount|
|1|1112|1112|Mix Match 1111 Type 2|00001|140|
Then the JSON should have the following format :
{"Transaction":{"TransactionMode":0,"Sale":{"ItemID":"8865545775651","Department":"0143","Description":{"en":"sample product 1.1","jp":"サンプル製品1.1"},"RegularSalesUnitPrice":130.0,"Discount":0.0,"DiscountFlag":0,"DiscountAmount":0.0,"ActualSalesUnitPrice":130.0,"Discountable":true,"TaxRate":0,"TaxType":0,"DiscountType":0,"NonSales":0,"SubInt10":0,"Line":"0143","Class":"000001","AgeRestrictedFlag":1,"EmpPrice1":130.0,"PSType":"","OrgSalesPrice1":0.0,"ItemEntryID":"00001","ItemIDType":"EAN-13","Quantity":4,"ExtendedAmount":520.0,"InputType":0},"EntryFlag":0},"Promotion":{"Discount":[{"RewardID":1,"EarnedRewardID":"1112","PromotionCode":"1112","DiscountDescription":"Mix Match 1111 Type 2","ItemEntryID":"00001","UnitDiscountAmt":140,"Quantity":3}],"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0},"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0}
Then there should be no revoke

Scenario: Item Entry (same items, one item entry id, continue to 2nd step discount, use excess from previous)
When a Item Entry at promotion with parameters RetailStoreID{0031} WorkStationId{1111} SequenceNo{1} TransactionJson{{"Sale":{"ItemEntryID":"00002","ItemID":"8865545775641","ItemIDType":"EAN-13","Quantity":2}}}
Then the Result Code is 0
Then Sale data should be :
|ItemEntryID|ItemID       |ItemIDType|Quantity|Department|DescriptionEN   |DescriptionJP   |RegularSalesUnitPrice|Discount|DiscountAmount|ActualSalesUnitPrice|ExtendedAmount|Discountable|AgeRestrictedFlag|CouponFlag|
|00002      |8865545775641|EAN-13    |2       |0143      |sample product 1|サンプル製品1      |100.0                |0.0     |0.0           |100.0               |200.0         |True        |1                |0         |
Then promotion should have the following data :
|RewardID|EarnedRewardID|PromotionCode|DiscountDescription|ItemEntryID|UnitDiscountAmount|
|1|1112|1112|Mix Match 1111 Type 2|00001|140|
|2|1112|1112|Mix Match 1111 Type 2|00001|32|
|3|1112|1112|Mix Match 1111 Type 2|00002|48|
Then the JSON should have the following format :
{"Transaction":{"TransactionMode":0,"Sale":{"ItemID":"8865545775641","Department":"0143","Description":{"en":"sample product 1","jp":"サンプル製品1"},"RegularSalesUnitPrice":100.0,"Discount":0.0,"DiscountFlag":0,"DiscountAmount":0.0,"ActualSalesUnitPrice":100.0,"Discountable":true,"TaxRate":0,"TaxType":0,"DiscountType":0,"NonSales":0,"SubInt10":0,"Line":"0143","Class":"000001","AgeRestrictedFlag":1,"CouponFlag":"0","EmpPrice1":100.0,"PSType":"","OrgSalesPrice1":0.0,"ItemEntryID":"00002","ItemIDType":"EAN-13","Quantity":2,"ExtendedAmount":200.0,"InputType":0},"EntryFlag":0},"Promotion":{"Discount":[{"RewardID":1,"EarnedRewardID":"1112","PromotionCode":"1112","DiscountDescription":"Mix Match 1111 Type 2","ItemEntryID":"00001","UnitDiscountAmt":140,"Quantity":3},{"RewardID":2,"EarnedRewardID":"1112","PromotionCode":"1112","DiscountDescription":"Mix Match 1111 Type 2","ItemEntryID":"00001","UnitDiscountAmt":32,"Quantity":1},{"RewardID":3,"EarnedRewardID":"1112","PromotionCode":"1112","DiscountDescription":"Mix Match 1111 Type 2","ItemEntryID":"00002","UnitDiscountAmt":48,"Quantity":2}],"Revoke":{"EarnedRewardID":"1112"},"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0},"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0}
Then there should be revoke

Scenario: Item Entry (same items, one item entry, multiple quantity, total amount < MMP) 
When a Begin Transaction at promotion with parameters RetailStoreID{0031} WorkStationId{1111} SequenceNo{1} TransactionJson{{"TransactionMode":"0","OperatorID": "0003","BeginDateTime":"2012-12-20T09:30:47.00"}}
When a Item Entry at promotion with parameters RetailStoreID{0031} WorkStationId{1111} SequenceNo{1} TransactionJson{{"Sale":{"ItemEntryID":"00001","ItemID":"8865545775642","ItemIDType":"EAN-13","Quantity":2}}}
Then the Result Code is 0
Then Sale data should be :
|ItemEntryID|ItemID       |ItemIDType|Quantity|Department|DescriptionEN   |DescriptionJP   |RegularSalesUnitPrice|Discount|DiscountAmount|ActualSalesUnitPrice|ExtendedAmount|Discountable|AgeRestrictedFlag|CouponFlag|
|00001      |8865545775642|EAN-13    |2       |0143      |sample product 2|サンプル製品2      |6300.0               |0.0     |0.0           |6300.0              |12600.0       |True        |0                |1         |
Then there should be no promotion data.

Scenario: Continue to 2nd step Item Entry (same items, one item entry, multiple quantity, total amount < MMP)
When a Item Entry at promotion with parameters RetailStoreID{0031} WorkStationId{1111} SequenceNo{1} TransactionJson{{"Sale":{"ItemEntryID":"00002","ItemID":"8865545775642","ItemIDType":"EAN-13","Quantity":2}}}
Then the Result Code is 0
Then Sale data should be :
|ItemEntryID|ItemID       |ItemIDType|Quantity|Department|DescriptionEN   |DescriptionJP   |RegularSalesUnitPrice|Discount|DiscountAmount|ActualSalesUnitPrice|ExtendedAmount|Discountable|AgeRestrictedFlag|CouponFlag|
|00002      |8865545775642|EAN-13    |2       |0143      |sample product 2|サンプル製品2      |6300.0               |0.0     |0.0           |6300.0              |12600.0       |True        |0                |1         |
Then there should be no promotion data.

Scenario: Item Entry (same items, one item entry, multiple quantity for full 2nd step, total amount < MMP) 
When a Begin Transaction at promotion with parameters RetailStoreID{0031} WorkStationId{1111} SequenceNo{1} TransactionJson{{"TransactionMode":"0","OperatorID": "0003","BeginDateTime":"2012-12-20T09:30:47.00"}}
When a Item Entry at promotion with parameters RetailStoreID{0031} WorkStationId{1111} SequenceNo{1} TransactionJson{{"Sale":{"ItemEntryID":"00001","ItemID":"8865545775642","ItemIDType":"EAN-13","Quantity":4}}}
Then the Result Code is 0
Then Sale data should be :
|ItemEntryID|ItemID       |ItemIDType|Quantity|Department|DescriptionEN   |DescriptionJP   |RegularSalesUnitPrice|Discount|DiscountAmount|ActualSalesUnitPrice|ExtendedAmount|Discountable|AgeRestrictedFlag|CouponFlag|
|00001      |8865545775642|EAN-13    |4       |0143      |sample product 2|サンプル製品2      |6300.0               |0.0     |0.0           |6300.0              |25200.0       |True        |0                |1         |
Then there should be no promotion data.

Scenario: Item Entry (Mix prices, one item with low amount) 
When a Begin Transaction at promotion with parameters RetailStoreID{0031} WorkStationId{1111} SequenceNo{1} TransactionJson{{"TransactionMode":"0","OperatorID": "0003","BeginDateTime":"2012-12-20T09:30:47.00"}}
When a Item Entry at promotion with parameters RetailStoreID{0031} WorkStationId{1111} SequenceNo{1} TransactionJson{{"Sale":{"ItemEntryID":"00001","ItemID":"8865545775642","ItemIDType":"EAN-13","Quantity":1}}}
Then the Result Code is 0
Then Sale data should be :
|ItemEntryID|ItemID       |ItemIDType|Quantity|Department|DescriptionEN   |DescriptionJP   |RegularSalesUnitPrice|Discount|DiscountAmount|ActualSalesUnitPrice|ExtendedAmount|Discountable|AgeRestrictedFlag|CouponFlag|
|00001      |8865545775642|EAN-13    |1       |0143      |sample product 2|サンプル製品2      |6300.0               |0.0     |0.0           |6300.0              |6300.0        |True        |0                |1         |
When a Item Entry at promotion with parameters RetailStoreID{0031} WorkStationId{1111} SequenceNo{1} TransactionJson{{"Sale":{"ItemEntryID":"00002","ItemID":"8865545775643","ItemIDType":"EAN-13","Quantity":1}}}
Then the Result Code is 0
Then Sale data should be :
|ItemEntryID|ItemID       |ItemIDType|Quantity|Department|DescriptionEN   |DescriptionJP   |RegularSalesUnitPrice|Discount|DiscountAmount|ActualSalesUnitPrice|ExtendedAmount|Discountable|AgeRestrictedFlag|CouponFlag|
|00002      |8865545775643|EAN-13    |1       |0143      |sample product 3|サンプル製品3      |17850.0              |0.0     |0.0           |17850.0             |17850.0       |True        |1                |1         |
Then promotion should have the following data :
|RewardID|EarnedRewardID|PromotionCode|DiscountDescription|ItemEntryID|UnitDiscountAmount|
|1|1122|1122|Mix Match 1111 Type 2.1|00002|2328|
|2|1122|1122|Mix Match 1111 Type 2.1|00001|822|
Then the JSON should have the following format :
{"Transaction":{"TransactionMode":0,"Sale":{"ItemID":"8865545775643","Department":"0143","Description":{"en":"sample product 3","jp":"サンプル製品3"},"RegularSalesUnitPrice":17850.0,"Discount":0.0,"DiscountFlag":0,"DiscountAmount":0.0,"ActualSalesUnitPrice":17850.0,"Discountable":true,"TaxRate":0,"TaxType":0,"DiscountType":0,"NonSales":0,"SubInt10":0,"Line":"0143","Class":"000001","AgeRestrictedFlag":1,"CouponFlag":"1","EmpPrice1":17850.0,"PSType":"","OrgSalesPrice1":0.0,"ItemEntryID":"00002","ItemIDType":"EAN-13","Quantity":1,"ExtendedAmount":17850.0,"InputType":0},"EntryFlag":0},"Promotion":{"Discount":[{"RewardID":1,"EarnedRewardID":"1122","PromotionCode":"1122","DiscountDescription":"Mix Match 1111 Type 2.1","ItemEntryID":"00002","UnitDiscountAmt":2328,"Quantity":1},{"RewardID":2,"EarnedRewardID":"1122","PromotionCode":"1122","DiscountDescription":"Mix Match 1111 Type 2.1","ItemEntryID":"00001","UnitDiscountAmt":822,"Quantity":1}],"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0},"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0}
Then there should be no revoke

Scenario: Item Entry (same large item prices, trigger 1st step) 
When a Begin Transaction at promotion with parameters RetailStoreID{0031} WorkStationId{1111} SequenceNo{1} TransactionJson{{"TransactionMode":"0","OperatorID": "0003","BeginDateTime":"2012-12-20T09:30:47.00"}}
When a Item Entry at promotion with parameters RetailStoreID{0031} WorkStationId{1111} SequenceNo{1} TransactionJson{{"Sale":{"ItemEntryID":"00001","ItemID":"8865545775643","ItemIDType":"EAN-13","Quantity":2}}}
Then the Result Code is 0
Then Sale data should be :
|ItemEntryID|ItemID       |ItemIDType|Quantity|Department|DescriptionEN   |DescriptionJP   |RegularSalesUnitPrice|Discount|DiscountAmount|ActualSalesUnitPrice|ExtendedAmount|Discountable|AgeRestrictedFlag|CouponFlag|
|00001      |8865545775643|EAN-13    |2       |0143      |sample product 3|サンプル製品3      |17850.0              |0.0     |0.0           |17850.0             |35700.0       |True        |1                |1         |
Then promotion should have the following data :
|RewardID|EarnedRewardID|PromotionCode|DiscountDescription|ItemEntryID|UnitDiscountAmount|
|1|1122|1122|Mix Match 1111 Type 2.1|00001|14700|
Then there should be no revoke

Scenario: Item Entry (same small item prices, trigger 2nd step) 
When a Item Entry at promotion with parameters RetailStoreID{0031} WorkStationId{1111} SequenceNo{1} TransactionJson{{"Sale":{"ItemEntryID":"00002","ItemID":"8865545775642","ItemIDType":"EAN-13","Quantity":2}}}
Then the Result Code is 0
Then Sale data should be :
|ItemEntryID|ItemID       |ItemIDType|Quantity|Department|DescriptionEN   |DescriptionJP   |RegularSalesUnitPrice|Discount|DiscountAmount|ActualSalesUnitPrice|ExtendedAmount|Discountable|AgeRestrictedFlag|CouponFlag|
|00002      |8865545775642|EAN-13    |2       |0143      |sample product 2|サンプル製品2      |6300.0               |0.0     |0.0           |6300.0              |12600.0       |True        |0                |1         |
Then promotion should have the following data :
|RewardID|EarnedRewardID|PromotionCode|DiscountDescription|ItemEntryID|UnitDiscountAmount|
|1|1122|1122|Mix Match 1111 Type 2.1|00001|6208|
|2|1122|1122|Mix Match 1111 Type 2.1|00002|2192|
Then there should be revoke