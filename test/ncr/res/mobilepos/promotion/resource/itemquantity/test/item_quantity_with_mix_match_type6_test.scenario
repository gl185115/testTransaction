Scenario: Test Item Quantity with MixMatch Type 6
When the Web API Starts Up
Given a Promotion Service
Given a loaded dataset {items_for_mixmatch.xml}
Given a loaded dataset {mixmatch_promotions.xml}

!-- Add a single item (EntryID:00001, qty: 1)
When a Begin Transaction at promotion with parameters RetailStoreID{0031} WorkStationId{1111} SequenceNo{1} TransactionJson{{"TransactionMode":"0","OperatorID": "0003","BeginDateTime":"2012-12-20T09:30:47.00"}}
When a Item Entry at promotion with parameters RetailStoreID{0031} WorkStationId{1111} SequenceNo{1} TransactionJson{{"Sale":{"ItemEntryID":"00001","ItemID":"9965545775601","ItemIDType":"EAN-13","Quantity":1}}}

Scenario: Item ADD Update (EntryID:00001, qty: 2) with 1st Step Mix Match triggered, no Revoke expected.
When I request to update Item Quantity at promotion with parameters RetailStoreID{0031} WorkStationID{1111} SequenceNo{1} and TransactionJson{{"EntryFlag": 2,"Sale":{"ItemEntryID":"00001","Quantity":"1"}}}
Then promotion should have the following data for update quantity:
|RewardID|EarnedRewardID|PromotionCode|DiscountDescription  |ItemEntryID|UnitDiscountAmount|
|1       |6000          |6000         |Mix Match 5555 Type 6|00001      |20                |
Then the JSON should have the following format : {"Promotion":{"Discount":[{"RewardID":1,"EarnedRewardID":"6000","PromotionCode":"6000","DiscountDescription":"Mix Match 5555 Type 6","ItemEntryID":"00001","UnitDiscountAmt":20,"Quantity":2}],"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0},"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0}

Scenario: Item ADD Update (EntryID:00001, qty: 3) with 2nd Step Mix Match triggered, Revoke expected.
When I request to update Item Quantity at promotion with parameters RetailStoreID{0031} WorkStationID{1111} SequenceNo{1} and TransactionJson{{"EntryFlag": 2,"Sale":{"ItemEntryID":"00001","Quantity":"1"}}}
Then promotion should have the following data for update quantity:
|RewardID|EarnedRewardID|PromotionCode|DiscountDescription  |ItemEntryID|UnitDiscountAmount|
|1       |6000          |6000         |Mix Match 5555 Type 6|00001      |60                |
Then the JSON should have the following format : {"Promotion":{"Discount":[{"RewardID":1,"EarnedRewardID":"6000","PromotionCode":"6000","DiscountDescription":"Mix Match 5555 Type 6","ItemEntryID":"00001","UnitDiscountAmt":60,"Quantity":3}],"Revoke":{"EarnedRewardID":"6000"},"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0},"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0}

Scenario: Item ADD Update (EntryID:00001, qty: 4) with 2nd Step Mix Match triggered, Revoke expected.
When I request to update Item Quantity at promotion with parameters RetailStoreID{0031} WorkStationID{1111} SequenceNo{1} and TransactionJson{{"EntryFlag": 2,"Sale":{"ItemEntryID":"00001","Quantity":"1"}}}
Then promotion should have the following data for update quantity:
|RewardID|EarnedRewardID|PromotionCode|DiscountDescription  |ItemEntryID|UnitDiscountAmount|
|1       |6000          |6000         |Mix Match 5555 Type 6|00001      |60                |
Then the JSON should have the following format : {"Promotion":{"Discount":[{"RewardID":1,"EarnedRewardID":"6000","PromotionCode":"6000","DiscountDescription":"Mix Match 5555 Type 6","ItemEntryID":"00001","UnitDiscountAmt":60,"Quantity":3}],"Revoke":{"EarnedRewardID":"6000"},"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0},"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0}

Scenario: Item ADD Update (EntryID:00001, qty: 5) with 2nd Step Mix Match triggered, Revoke expected.
When I request to update Item Quantity at promotion with parameters RetailStoreID{0031} WorkStationID{1111} SequenceNo{1} and TransactionJson{{"EntryFlag": 2,"Sale":{"ItemEntryID":"00001","Quantity":"1"}}}
Then promotion should have the following data for update quantity:
|RewardID|EarnedRewardID|PromotionCode|DiscountDescription  |ItemEntryID|UnitDiscountAmount|
|1       |6000          |6000         |Mix Match 5555 Type 6|00001      |60                |
|2       |6000          |6000         |Mix Match 5555 Type 6|00001      |20                |
Then the JSON should have the following format : {"Promotion":{"Discount":[{"RewardID":1,"EarnedRewardID":"6000","PromotionCode":"6000","DiscountDescription":"Mix Match 5555 Type 6","ItemEntryID":"00001","UnitDiscountAmt":60,"Quantity":3},{"RewardID":2,"EarnedRewardID":"6000","PromotionCode":"6000","DiscountDescription":"Mix Match 5555 Type 6","ItemEntryID":"00001","UnitDiscountAmt":20,"Quantity":2}],"Revoke":{"EarnedRewardID":"6000"},"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0},"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0}

Scenario: Item ADD Update (EntryID:00001, qty: 6) with 2nd Step Mix Match triggered, Revoke expected.
When I request to update Item Quantity at promotion with parameters RetailStoreID{0031} WorkStationID{1111} SequenceNo{1} and TransactionJson{{"EntryFlag": 2,"Sale":{"ItemEntryID":"00001","Quantity":"1"}}}
Then promotion should have the following data for update quantity:
|RewardID|EarnedRewardID|PromotionCode|DiscountDescription  |ItemEntryID|UnitDiscountAmount|
|1       |6000          |6000         |Mix Match 5555 Type 6|00001      |60                |
|2       |6000          |6000         |Mix Match 5555 Type 6|00001      |60                |
Then the JSON should have the following format : {"Promotion":{"Discount":[{"RewardID":1,"EarnedRewardID":"6000","PromotionCode":"6000","DiscountDescription":"Mix Match 5555 Type 6","ItemEntryID":"00001","UnitDiscountAmt":60,"Quantity":3},{"RewardID":2,"EarnedRewardID":"6000","PromotionCode":"6000","DiscountDescription":"Mix Match 5555 Type 6","ItemEntryID":"00001","UnitDiscountAmt":60,"Quantity":3}],"Revoke":{"EarnedRewardID":"6000"},"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0},"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0}

Scenario: Item ADD Update  for other item (EntryID:00001, qty: 6 | EntryID:00002, qty: 2) and 1st Step Mix Match also triggered for ItemEntry 0002, Revoke expected.
When a Item Entry at promotion with parameters RetailStoreID{0031} WorkStationId{1111} SequenceNo{1} TransactionJson{{"Sale":{"ItemEntryID":"00002","ItemID":"9965545775601","ItemIDType":"EAN-13","Quantity":1}}}
When I request to update Item Quantity at promotion with parameters RetailStoreID{0031} WorkStationID{1111} SequenceNo{1} and TransactionJson{{"EntryFlag": 2,"Sale":{"ItemEntryID":"00002","Quantity":"1"}}}
Then promotion should have the following data for update quantity:
|RewardID|EarnedRewardID|PromotionCode|DiscountDescription  |ItemEntryID|UnitDiscountAmount|
|1       |6000          |6000         |Mix Match 5555 Type 6|00002      |40                |
|2       |6000          |6000         |Mix Match 5555 Type 6|00001      |20                |
|3       |6000          |6000         |Mix Match 5555 Type 6|00001      |60                |
|4       |6000          |6000         |Mix Match 5555 Type 6|00001      |20                |
Then the JSON should have the following format : {"Promotion":{"Discount":[{"RewardID":1,"EarnedRewardID":"6000","PromotionCode":"6000","DiscountDescription":"Mix Match 5555 Type 6","ItemEntryID":"00002","UnitDiscountAmt":40,"Quantity":2},{"RewardID":2,"EarnedRewardID":"6000","PromotionCode":"6000","DiscountDescription":"Mix Match 5555 Type 6","ItemEntryID":"00001","UnitDiscountAmt":20,"Quantity":1},{"RewardID":3,"EarnedRewardID":"6000","PromotionCode":"6000","DiscountDescription":"Mix Match 5555 Type 6","ItemEntryID":"00001","UnitDiscountAmt":60,"Quantity":3},{"RewardID":4,"EarnedRewardID":"6000","PromotionCode":"6000","DiscountDescription":"Mix Match 5555 Type 6","ItemEntryID":"00001","UnitDiscountAmt":20,"Quantity":2}],"Revoke":{"EarnedRewardID":"6000"},"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0},"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0}

Scenario: Item ADD Update  for other item (EntryID:00001, qty: 6 | EntryID:00002, qty: 3) and 2nd Step Mix Match also triggered for ItemEntry 0002, Revoke expected.
When I request to update Item Quantity at promotion with parameters RetailStoreID{0031} WorkStationID{1111} SequenceNo{1} and TransactionJson{{"EntryFlag": 2,"Sale":{"ItemEntryID":"00002","Quantity":"1"}}}
Then promotion should have the following data for update quantity:
|RewardID|EarnedRewardID|PromotionCode|DiscountDescription  |ItemEntryID|UnitDiscountAmount|
|1       |6000          |6000         |Mix Match 5555 Type 6|00002      |60                |
|2       |6000          |6000         |Mix Match 5555 Type 6|00001      |60                |
|3       |6000          |6000         |Mix Match 5555 Type 6|00001      |60                |
Then the JSON should have the following format : {"Promotion":{"Discount":[{"RewardID":1,"EarnedRewardID":"6000","PromotionCode":"6000","DiscountDescription":"Mix Match 5555 Type 6","ItemEntryID":"00002","UnitDiscountAmt":60,"Quantity":3},{"RewardID":2,"EarnedRewardID":"6000","PromotionCode":"6000","DiscountDescription":"Mix Match 5555 Type 6","ItemEntryID":"00001","UnitDiscountAmt":60,"Quantity":3},{"RewardID":3,"EarnedRewardID":"6000","PromotionCode":"6000","DiscountDescription":"Mix Match 5555 Type 6","ItemEntryID":"00001","UnitDiscountAmt":60,"Quantity":3}],"Revoke":{"EarnedRewardID":"6000"},"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0},"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0}

Scenario: Item REMOVE Update  for other item (EntryID:00001, qty: 4 | EntryID:00002, qty: 3) and 2 Mix Match triggered, Revoke is expected.
When I request to update Item Quantity at promotion with parameters RetailStoreID{0031} WorkStationID{1111} SequenceNo{1} and TransactionJson{{"EntryFlag": 0,"Sale":{"ItemEntryID":"00001","Quantity":"2"}}}
Then promotion should have the following data for update quantity:
|RewardID|EarnedRewardID|PromotionCode|DiscountDescription  |ItemEntryID|UnitDiscountAmount|
|1       |6000          |6000         |Mix Match 5555 Type 6|00002      |60                |
|2       |6000          |6000         |Mix Match 5555 Type 6|00001      |60                |
Then the JSON should have the following format : {"Promotion":{"Discount":[{"RewardID":1,"EarnedRewardID":"6000","PromotionCode":"6000","DiscountDescription":"Mix Match 5555 Type 6","ItemEntryID":"00002","UnitDiscountAmt":60,"Quantity":3},{"RewardID":2,"EarnedRewardID":"6000","PromotionCode":"6000","DiscountDescription":"Mix Match 5555 Type 6","ItemEntryID":"00001","UnitDiscountAmt":60,"Quantity":3}],"Revoke":{"EarnedRewardID":"6000"},"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0},"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0}

Scenario: Item REMOVE Update  for other item (EntryID:00001, qty: 2 | EntryID:00002, qty: 3) and 2 Mix Match triggered, Revoke is expected.
When I request to update Item Quantity at promotion with parameters RetailStoreID{0031} WorkStationID{1111} SequenceNo{1} and TransactionJson{{"EntryFlag": 0,"Sale":{"ItemEntryID":"00001","Quantity":"2"}}}
Then promotion should have the following data for update quantity:
|RewardID|EarnedRewardID|PromotionCode|DiscountDescription  |ItemEntryID|UnitDiscountAmount|
|1       |6000          |6000         |Mix Match 5555 Type 6|00002      |60                |
|2       |6000          |6000         |Mix Match 5555 Type 6|00001      |20                |
Then the JSON should have the following format : {"Promotion":{"Discount":[{"RewardID":1,"EarnedRewardID":"6000","PromotionCode":"6000","DiscountDescription":"Mix Match 5555 Type 6","ItemEntryID":"00002","UnitDiscountAmt":60,"Quantity":3},{"RewardID":2,"EarnedRewardID":"6000","PromotionCode":"6000","DiscountDescription":"Mix Match 5555 Type 6","ItemEntryID":"00001","UnitDiscountAmt":20,"Quantity":2}],"Revoke":{"EarnedRewardID":"6000"},"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0},"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0}

Scenario: Item REMOVE Update  for other item (EntryID:00001, qty: 1 | EntryID:00002, qty: 3) and 1 Mix Match triggered, Revoke is expected.
When I request to update Item Quantity at promotion with parameters RetailStoreID{0031} WorkStationID{1111} SequenceNo{1} and TransactionJson{{"EntryFlag": 0,"Sale":{"ItemEntryID":"00001","Quantity":"1"}}}
Then promotion should have the following data for update quantity:
|RewardID|EarnedRewardID|PromotionCode|DiscountDescription  |ItemEntryID|UnitDiscountAmount|
|1       |6000          |6000         |Mix Match 5555 Type 6|00002      |60                |
Then the JSON should have the following format : {"Promotion":{"Discount":[{"RewardID":1,"EarnedRewardID":"6000","PromotionCode":"6000","DiscountDescription":"Mix Match 5555 Type 6","ItemEntryID":"00002","UnitDiscountAmt":60,"Quantity":3}],"Revoke":{"EarnedRewardID":"6000"},"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0},"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0}

Scenario: Item REMOVE Update  for other item (EntryID:00002, qty: 3) and 2nd step Mix Match triggered, Revoke is expected.
When I request to update Item Quantity at promotion with parameters RetailStoreID{0031} WorkStationID{1111} SequenceNo{1} and TransactionJson{{"EntryFlag": 0,"Sale":{"ItemEntryID":"00001","Quantity":"1"}}}
Then promotion should have the following data for update quantity:
|RewardID|EarnedRewardID|PromotionCode|DiscountDescription  |ItemEntryID|UnitDiscountAmount|
|1       |6000          |6000         |Mix Match 5555 Type 6|00002      |60                |
Then the JSON should have the following format : {"Promotion":{"Discount":[{"RewardID":1,"EarnedRewardID":"6000","PromotionCode":"6000","DiscountDescription":"Mix Match 5555 Type 6","ItemEntryID":"00002","UnitDiscountAmt":60,"Quantity":3}],"Revoke":{"EarnedRewardID":"6000"},"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0},"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0}

Scenario: Item REMOVE Update  for  item (EntryID:00002, qty: 2) and 1st step  Mix Match triggered, Revoke is expected.
When I request to update Item Quantity at promotion with parameters RetailStoreID{0031} WorkStationID{1111} SequenceNo{1} and TransactionJson{{"EntryFlag": 0,"Sale":{"ItemEntryID":"00002","Quantity":"1"}}}
Then promotion should have the following data for update quantity:
|RewardID|EarnedRewardID|PromotionCode|DiscountDescription  |ItemEntryID|UnitDiscountAmount|
|1       |6000          |6000         |Mix Match 5555 Type 6|00002      |20                |
Then the JSON should have the following format : {"Promotion":{"Discount":[{"RewardID":1,"EarnedRewardID":"6000","PromotionCode":"6000","DiscountDescription":"Mix Match 5555 Type 6","ItemEntryID":"00002","UnitDiscountAmt":20,"Quantity":2}],"Revoke":{"EarnedRewardID":"6000"},"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0},"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0}

Scenario: Item REMOVE Update  for  item (EntryID:00002, qty: 1) and No Mix Match triggered, Revoke is expected.
When I request to update Item Quantity at promotion with parameters RetailStoreID{0031} WorkStationID{1111} SequenceNo{1} and TransactionJson{{"EntryFlag": 0,"Sale":{"ItemEntryID":"00002","Quantity":"1"}}}
Then there should be no Discount promotion data for update quantity.
Then the JSON should have the following format : {"Promotion":{"Discount":[],"Revoke":{"EarnedRewardID":"6000"},"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0},"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0}

Scenario: Item REMOVE ALL item  for other item (No Item Entry) and No Mix Match triggered, Revoke is no more expected.
When I request to update Item Quantity at promotion with parameters RetailStoreID{0031} WorkStationID{1111} SequenceNo{1} and TransactionJson{{"EntryFlag": 0,"Sale":{"ItemEntryID":"00002","Quantity":"1"}}}
Then there should be no Discount promotion data for update quantity.
Then the JSON should have the following format : {"Promotion":{"Discount":[],"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0},"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0}

When I request to update Item Quantity at promotion with parameters RetailStoreID{0031} WorkStationID{1111} SequenceNo{1} and TransactionJson{{"EntryFlag": 0,"Sale":{"ItemEntryID":"00002","Quantity":"2"}}}
Then there should be no Discount promotion data for update quantity.
Then the Result Code is 1110

When I request to update Item Quantity at promotion with parameters RetailStoreID{0031} WorkStationID{1111} SequenceNo{1} and TransactionJson{{"EntryFlag": 2,"Sale":{"ItemEntryID":"00002","Quantity":"2"}}}
Then there should be no Discount promotion data for update quantity.
Then the Result Code is 1110