Scenario: Test Item Entry with MixMatch Type 3
When the Web API Starts Up
Given a Promotion Service
Given a loaded dataset {items_for_mixmatch.xml}
Given a loaded dataset {mixmatch_promotions.xml}

!-- Add a single item (EntryID:00001, qty: 1)
When a Begin Transaction at promotion with parameters RetailStoreID{0031} WorkStationId{1111} SequenceNo{1} TransactionJson{{"TransactionMode":"0","OperatorID": "0003","BeginDateTime":"2012-12-20T09:30:47.00"}}
When a Item Entry at promotion with parameters RetailStoreID{0031} WorkStationId{1111} SequenceNo{1} TransactionJson{{"Sale":{"ItemEntryID":"00001","ItemID":"8865545775631","ItemIDType":"EAN-13","Quantity":1}}}
Then Sale data should be :
|ItemEntryID|ItemID|ItemIDType|Quantity|Department|Description|RegularSalesUnitPrice|Discount|DiscountAmount|ActualSalesUnitPrice|ExtendedAmount|Discountable|
|00001|8865545775631|EAN-13|1|0143|sample product 3|110.0|0%|0.0|110.0|110.0|True|

Scenario: Item ADD Update (EntryID:00001, qty: 2) but was no Mix Match triggered
When I request to update Item Quantity at promotion with parameters RetailStoreID{0031} WorkStationID{1111} SequenceNo{1} and TransactionJson{{"EntryFlag": 2,"Sale":{"ItemEntryID":"00001","Quantity":"1"}}}
Then there should be no Discount promotion data for update quantity.
Then the JSON should have the following format : {"Promotion":{"Discount":[],"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0},"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0}

Scenario: Item ADD Update (EntryID:00001, qty: 3) and Mix Match triggered, Revoke is not expected.
When I request to update Item Quantity at promotion with parameters RetailStoreID{0031} WorkStationID{1111} SequenceNo{1} and TransactionJson{{"EntryFlag": 2,"Sale":{"ItemEntryID":"00001","Quantity":"1"}}}
Then promotion should have the following data for update quantity:
|RewardID|EarnedRewardID|PromotionCode|DiscountDescription  |ItemEntryID|UnitDiscountAmount|
|1       |1002          |1002         |Mix Match 1002 Type 3|00001      |30                |
Then the JSON should have the following format : {"Promotion":{"Discount":[{"RewardID":1,"EarnedRewardID":"1002","PromotionCode":"1002","DiscountDescription":"Mix Match 1002 Type 3","ItemEntryID":"00001","UnitDiscountAmt":30,"Quantity":3}],"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0},"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0}
Then there should be no revoke


Scenario: Additional Item ADD Update (EntryID:00001, qty: 4) and Mix Match triggered, Revoke is now expected.
When I request to update Item Quantity at promotion with parameters RetailStoreID{0031} WorkStationID{1111} SequenceNo{1} and TransactionJson{{"EntryFlag": 2,"Sale":{"ItemEntryID":"00001","Quantity":"1"}}}
Then promotion should have the following data for update quantity:
|RewardID|EarnedRewardID|PromotionCode|DiscountDescription  |ItemEntryID|UnitDiscountAmount|
|1       |1002          |1002         |Mix Match 1002 Type 3|00001       |40               |
Then the JSON should have the following format : {"Promotion":{"Discount":[{"RewardID":1,"EarnedRewardID":"1002","PromotionCode":"1002","DiscountDescription":"Mix Match 1002 Type 3","ItemEntryID":"00001","UnitDiscountAmt":40,"Quantity":4}],"Revoke":{"EarnedRewardID":"1002"},"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0},"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0}
Then there should be revoke

Scenario: Additional Item ADD Update (EntryID:00001, qty: 6) and Mix Match triggered, Revoke is now expected.
When I request to update Item Quantity at promotion with parameters RetailStoreID{0031} WorkStationID{1111} SequenceNo{1} and TransactionJson{{"EntryFlag": 2,"Sale":{"ItemEntryID":"00001","Quantity":"2"}}}
Then promotion should have the following data for update quantity:
|RewardID|EarnedRewardID|PromotionCode|DiscountDescription  |ItemEntryID|UnitDiscountAmount|
|1       |1002          |1002         |Mix Match 1002 Type 3|00001      |60                |
Then the JSON should have the following format : {"Promotion":{"Discount":[{"RewardID":1,"EarnedRewardID":"1002","PromotionCode":"1002","DiscountDescription":"Mix Match 1002 Type 3","ItemEntryID":"00001","UnitDiscountAmt":60,"Quantity":6}],"Revoke":{"EarnedRewardID":"1002"},"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0},"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0}
Then there should be revoke

Scenario: Item ADD Update  for other item (EntryID:00001, qty: 6 | EntryID:00002, qty: 3) and Mix Match triggered, Revoke is expected.
When a Item Entry at promotion with parameters RetailStoreID{0031} WorkStationId{1111} SequenceNo{1} TransactionJson{{"Sale":{"ItemEntryID":"00002","ItemID":"8865545775631","ItemIDType":"EAN-13","Quantity":1}}}
Then Sale data should be :
|ItemEntryID|ItemID|ItemIDType|Quantity|Department|Description|RegularSalesUnitPrice|Discount|DiscountAmount|ActualSalesUnitPrice|ExtendedAmount|Discountable|
|00002|8865545775631|EAN-13|1|0143|sample product 3|110.0|0%|0.0|110.0|110.0|True|
Then promotion should have the following data :
|RewardID|EarnedRewardID|PromotionCode|DiscountDescription|ItemEntryID|UnitDiscountAmount|
|1|1002|1002|Mix Match 1002 Type 3|00001|60|
|2|1002|1002|Mix Match 1002 Type 3|00002|10|
Then there should be revoke
When I request to update Item Quantity at promotion with parameters RetailStoreID{0031} WorkStationID{1111} SequenceNo{1} and TransactionJson{{"EntryFlag": 2,"Sale":{"ItemEntryID":"00002","Quantity":"2"}}}
Then promotion should have the following data for update quantity:
|RewardID|EarnedRewardID|PromotionCode|DiscountDescription  |ItemEntryID|UnitDiscountAmount|
|1       |1002          |1002         |Mix Match 1002 Type 3|00001      |60                |
|2       |1002          |1002         |Mix Match 1002 Type 3|00002      |30                |
Then the JSON should have the following format :
{"Promotion":{"Discount":[{"RewardID":1,"EarnedRewardID":"1002","PromotionCode":"1002","DiscountDescription":"Mix Match 1002 Type 3","ItemEntryID":"00001","UnitDiscountAmt":60,"Quantity":6},{"RewardID":2,"EarnedRewardID":"1002","PromotionCode":"1002","DiscountDescription":"Mix Match 1002 Type 3","ItemEntryID":"00002","UnitDiscountAmt":30,"Quantity":3}],"Revoke":{"EarnedRewardID":"1002"},"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0},"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0}
Then there should be revoke


Scenario: Item REMOVE Update  for other item (EntryID:00001, qty: 4 | EntryID:00002, qty: 3) and 2 Mix Match triggered, Revoke is now expected.
When I request to update Item Quantity at promotion with parameters RetailStoreID{0031} WorkStationID{1111} SequenceNo{1} and TransactionJson{{"EntryFlag": 0,"Sale":{"ItemEntryID":"00001","Quantity":"2"}}}
Then promotion should have the following data for update quantity:
|RewardID|EarnedRewardID|PromotionCode|DiscountDescription  |ItemEntryID|UnitDiscountAmount|
|1       |1002          |1002         |Mix Match 1002 Type 3|00001      |40                |
|2       |1002          |1002         |Mix Match 1002 Type 3|00002      |30                |
Then the JSON should have the following format : {"Promotion":{"Discount":[{"RewardID":1,"EarnedRewardID":"1002","PromotionCode":"1002","DiscountDescription":"Mix Match 1002 Type 3","ItemEntryID":"00001","UnitDiscountAmt":40,"Quantity":4},{"RewardID":2,"EarnedRewardID":"1002","PromotionCode":"1002","DiscountDescription":"Mix Match 1002 Type 3","ItemEntryID":"00002","UnitDiscountAmt":30,"Quantity":3}],"Revoke":{"EarnedRewardID":"1002"},"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0},"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0}
Then there should be revoke

Scenario: Item REMOVE Update  for other item (EntryID:00001, qty: 2 | EntryID:00002, qty: 3) and 1 Mix Match triggered, Revoke is now expected.
When I request to update Item Quantity at promotion with parameters RetailStoreID{0031} WorkStationID{1111} SequenceNo{1} and TransactionJson{{"EntryFlag": 0,"Sale":{"ItemEntryID":"00001","Quantity":"2"}}}
Then promotion should have the following data for update quantity:
|RewardID|EarnedRewardID|PromotionCode|DiscountDescription  |ItemEntryID|UnitDiscountAmount|
|1       |1002          |1002         |Mix Match 1002 Type 3|00001      |20                |
|2       |1002          |1002         |Mix Match 1002 Type 3|00002      |30                |
Then the JSON should have the following format : {"Promotion":{"Discount":[{"RewardID":1,"EarnedRewardID":"1002","PromotionCode":"1002","DiscountDescription":"Mix Match 1002 Type 3","ItemEntryID":"00001","UnitDiscountAmt":20,"Quantity":2},{"RewardID":2,"EarnedRewardID":"1002","PromotionCode":"1002","DiscountDescription":"Mix Match 1002 Type 3","ItemEntryID":"00002","UnitDiscountAmt":30,"Quantity":3}],"Revoke":{"EarnedRewardID":"1002"},"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0},"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0}
Then there should be revoke

Scenario: Item REMOVE Update  for other item (EntryID:00002, qty: 3) and 1 Mix Match triggered, Revoke is now expected.
When I request to update Item Quantity at promotion with parameters RetailStoreID{0031} WorkStationID{1111} SequenceNo{1} and TransactionJson{{"EntryFlag": 0,"Sale":{"ItemEntryID":"00001","Quantity":"2"}}}
Then promotion should have the following data for update quantity:
|RewardID|EarnedRewardID|PromotionCode|DiscountDescription  |ItemEntryID|UnitDiscountAmount|
|1       |1002          |1002         |Mix Match 1002 Type 3|00002      |30                |
Then the JSON should have the following format : {"Promotion":{"Discount":[{"RewardID":1,"EarnedRewardID":"1002","PromotionCode":"1002","DiscountDescription":"Mix Match 1002 Type 3","ItemEntryID":"00002","UnitDiscountAmt":30,"Quantity":3}],"Revoke":{"EarnedRewardID":"1002"},"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0},"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0}
Then there should be revoke

Scenario: Item REMOVE Update  for other item (EntryID:00002, qty: 2) and No Mix Match triggered, Revoke is still expected.
When I request to update Item Quantity at promotion with parameters RetailStoreID{0031} WorkStationID{1111} SequenceNo{1} and TransactionJson{{"EntryFlag": 0,"Sale":{"ItemEntryID":"00002","Quantity":"1"}}}
Then there should be no Discount promotion data for update quantity.
Then the JSON should have the following format : {"Promotion":{"Discount":[],"Revoke":{"EarnedRewardID":"1002"},"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0},"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0}
Then there should be revoke

Scenario: Item REMOVE ALL item  for other item (No Item Entry) and No Mix Match triggered, Revoke is no more expected.
When I request to update Item Quantity at promotion with parameters RetailStoreID{0031} WorkStationID{1111} SequenceNo{1} and TransactionJson{{"EntryFlag": 0,"Sale":{"ItemEntryID":"00002","Quantity":"2"}}}
Then there should be no Discount promotion data for update quantity.
Then the JSON should have the following format : {"Promotion":{"Discount":[],"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0},"NCRWSSResultCode":0,"NCRWSSExtendedResultCode":0}
Then there should be no revoke

When I request to update Item Quantity at promotion with parameters RetailStoreID{0031} WorkStationID{1111} SequenceNo{1} and TransactionJson{{"EntryFlag": 0,"Sale":{"ItemEntryID":"00002","Quantity":"2"}}}
Then there should be no Discount promotion data for update quantity.
Then the Result Code is 1110

When I request to update Item Quantity at promotion with parameters RetailStoreID{0031} WorkStationID{1111} SequenceNo{1} and TransactionJson{{"EntryFlag": 2,"Sale":{"ItemEntryID":"00002","Quantity":"2"}}}
Then there should be no Discount promotion data for update quantity.
Then the Result Code is 1110


Scenario: Item Entry (same items, different item entry id) 
When a Begin Transaction at promotion with parameters RetailStoreID{0031} WorkStationId{1111} SequenceNo{1} TransactionJson{{"TransactionMode":"0","OperatorID": "0003","BeginDateTime":"2012-12-20T09:30:47.00"}}
When a Item Entry at promotion with parameters RetailStoreID{0031} WorkStationId{1111} SequenceNo{1} TransactionJson{{"Sale":{"ItemEntryID":"00001","ItemID":"8865545775731","ItemIDType":"EAN-13","Quantity":1}}}
Then the Result Code is 0
Then Sale data should be :
|ItemEntryID|ItemID|ItemIDType|Quantity|Department|Description|RegularSalesUnitPrice|Discount|DiscountAmount|ActualSalesUnitPrice|ExtendedAmount|Discountable|
|00001|8865545775731|EAN-13|1|0143|sample product 3.1|90.0|0%|0.0|90.0|90.0|True|
Then there should be no promotion data.
When a Item Entry at promotion with parameters RetailStoreID{0031} WorkStationId{1111} SequenceNo{1} TransactionJson{{"Sale":{"ItemEntryID":"00002","ItemID":"8865545775632","ItemIDType":"EAN-13","Quantity":1}}}
Then the Result Code is 0
Then Sale data should be :
|ItemEntryID|ItemID|ItemIDType|Quantity|Department|Description|RegularSalesUnitPrice|Discount|DiscountAmount|ActualSalesUnitPrice|ExtendedAmount|Discountable|
|00002|8865545775632|EAN-13|1|0143|sample product 4|120.0|0%|0.0|120.0|120.0|True|
When I request to update Item Quantity at promotion with parameters RetailStoreID{0031} WorkStationID{1111} SequenceNo{1} and TransactionJson{{"EntryFlag": 2,"Sale":{"ItemEntryID":"00002","Quantity":"1"}}}
Then promotion should have the following data for update quantity:
|RewardID|EarnedRewardID|PromotionCode|DiscountDescription|ItemEntryID|UnitDiscountAmount|
|1|1002|1002|Mix Match 1002 Type 3|00002|22|
|2|1002|1002|Mix Match 1002 Type 3|00001|8|

When I request to update Item Quantity at promotion with parameters RetailStoreID{0031} WorkStationID{1111} SequenceNo{1} and TransactionJson{{"EntryFlag": 2,"Sale":{"ItemEntryID":"00001","Quantity":"1"}}}
Then promotion should have the following data for update quantity:
|RewardID|EarnedRewardID|PromotionCode|DiscountDescription|ItemEntryID|UnitDiscountAmount|
|1|1002|1002|Mix Match 1002 Type 3|00002|18|
|2|1002|1002|Mix Match 1002 Type 3|00001|12|

When I request to update Item Quantity at promotion with parameters RetailStoreID{0031} WorkStationID{1111} SequenceNo{1} and TransactionJson{{"EntryFlag": 2,"Sale":{"ItemEntryID":"00002","Quantity":"2"}}}
Then promotion should have the following data for update quantity:
|RewardID|EarnedRewardID|PromotionCode|DiscountDescription|ItemEntryID|UnitDiscountAmount|
|1|1002|1002|Mix Match 1002 Type 3|00002|60|
|2|1002|1002|Mix Match 1002 Type 3|00001|20|

When I request to update Item Quantity at promotion with parameters RetailStoreID{0031} WorkStationID{1111} SequenceNo{1} and TransactionJson{{"EntryFlag": 0,"Sale":{"ItemEntryID":"00002","Quantity":"2"}}}
Then promotion should have the following data for update quantity:
|RewardID|EarnedRewardID|PromotionCode|DiscountDescription|ItemEntryID|UnitDiscountAmount|
|1|1002|1002|Mix Match 1002 Type 3|00002|18|
|2|1002|1002|Mix Match 1002 Type 3|00001|12|

When I request to update Item Quantity at promotion with parameters RetailStoreID{0031} WorkStationID{1111} SequenceNo{1} and TransactionJson{{"EntryFlag": 2,"Sale":{"ItemEntryID":"00001","Quantity":"1"}}}
Then promotion should have the following data for update quantity:
|RewardID|EarnedRewardID|PromotionCode|DiscountDescription|ItemEntryID|UnitDiscountAmount|
|1|1002|1002|Mix Match 1002 Type 3|00002|14|
|2|1002|1002|Mix Match 1002 Type 3|00001|16|
